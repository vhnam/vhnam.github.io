<!DOCTYPE html><html lang="vi"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"        /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta name="robots" content="noodp,index,follow" /><meta name="revisit-after" content="1 days" /><meta name="google-site-verification" content="ZFrkEu3QMFl9Kz0JyK2SfzdIZ84lDgm9gLQ6J6FmAvg"        /><meta name="p:domain_verify" content="faa7b25edce176988fb8171e9457554a"        /><meta property="og:url" content="https://vhnam.github.io/tutorials/cau-hinh-aws-cloudfront-va-s3"        /><meta property="og:type" content="article" /><meta property="og:title" content="Cấu hình AWS CloudFront và S3" /><meta property="og:description" content="Bài toán đặt ra là cấu hình header cho ứng dụng được lưu trên S3. Giải pháp là dùng CloudFront để cấu hình header của response" /><meta property="og:image" content="https://vhnam.github.io/tutorials/cau-hinh-aws-cloudfront-va-s3/img/thumbnails.jpg"        /><meta property="og:locale" content="vi_VN" /><meta property="fb:app_id" content="2064203853819553" /><title>Cấu hình AWS CloudFront và S3 | Nam Vo</title><link rel="shortcut icon" href="/src/assets/favicon.ico" type="image/x-icon"        /><link rel="canonical" href="http://vhnam.github.io/" /><link rel="preload" href="/src/assets/css/bootstrap.css" as="style" /><link rel="preload" href="/src/assets/css/theme.css" as="style" /><link rel="preload" href="/src/assets/css/pages/post.css" as="style" /><link rel="preload" href="/src/assets/js/dist/bundle.js" as="script" /><link rel="preload" href="/src/assets/js/post.js" as="script" /><link rel="stylesheet" href="/src/assets/css/bootstrap.css" /><link rel="stylesheet" href="/src/assets/css/theme.css" /><link rel="stylesheet" href="/src/assets/css/pages/post.css" /><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body itemscope="itemscope" itemtype="https://schema.org/BlogPosting"><nav class="navbar navbar-expand-lg navbar-light sticky-top bg-light shadow"><div class="container"><a class="navbar-brand logo" href="/">Nam Vo</a><button class="navbar-toggler" type="button"                    data-toggle="collapse"                    data-target="#navbarNavDropdown"                    aria-controls="navbarNavDropdown"                    aria-expanded="false"                    aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavDropdown"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" id="blog" href="/blog">Nhật ký</a                            ></li><li class="nav-item"><a class="nav-link" id="tutorials" href="/tutorials">Chuyện ngành</a                            ></li><li class="nav-item"><a class="nav-link" id="portfolio" href="#">Portfolio</a                            ></li><li class="nav-item"><a class="nav-link" id="about" href="/about.html">Thông tin</a                            ></li><li class="nav-item"><a class="nav-link" id="contact" href="/contact.html">Liên lạc</a                            ></li></ul></div></div></nav><section class="content"><div class="container"><div class="row"><div class="col-lg-8"><div class="content__heading"><h1 class="content__title" itemprop="headline">                                Cấu hình AWS CloudFront và S3                            </h1><p class="content__time">Ngày 9 tháng 10 năm 2018</p><meta itemprop="author" content="Nam Vo" /><meta itemprop="datePublished" content="2018-10-09"                            /><meta itemprop="dateModified" content="2018-10-09"                            /><meta itemprop="mainEntityOfPage" content="Bài toán đặt ra là cấu hình header cho ứng dụng được lưu trên S3. Giải pháp là dùng CloudFront để cấu hình header của response"                            /></div><p>    Công việc hiện tại, mình dùng AWS S3 để host static web. Do có việc phải gắn header vào response mỗi khi tải view, nhưng không thành công khi nhúng vào thẻ <code>meta</code>. Sau một hồi nhờ vả và Google đã tìm ra giải pháp gắn header vào CloudFront rồi kết nối tới S3. Nhân tiện ghi chú lại cho người sau luôn.</p><img alt="Config AWS CloudFront with AWS S3" itemprop="image" src="img/thumbnails.jpg"/><span class="heading" id="vn-"></span><h2>Vấn đề</h2><p>    Cụ thể, mình cần gắn header <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy" itemprop="url">Content-Security-Policy</a> ở trong thẻ <code>meta</code>. Tuy nhiên, kết quả không chạy.</p><img alt="Set header on metadata" itemprop="image" src="img/failed-set-header.jpg"/><img alt="Failed in Response" itemprop="image" src="img/failed-network.jpg"/><span class="heading" id="gii-php"></span><h2>Giải pháp</h2><p>    Với vấn đề của mình, có tất cả 3 giải pháp.</p><span class="heading" id="gii-php-1"></span><h3>Giải pháp 1</h3><p>    Giải pháp 1 đó là dựng một server bằng Express (Node.js), Spring (Java), Laravel (PHP),... và gắn middleware để xử lý việc response trả về sẽ tự động gắn header. Ở đây, mình dùng AWS S3, chỉ hỗ trợ static web nên giải pháp này thất bại.</p><span class="heading" id="gii-php-2"></span><h3>Giải pháp 2</h3><p>    Giải pháp này là can thiệp vào Web Server như Apache, Nginx, IIS,... để gắn header. Về phía AWS không có vụ này nên coi như tạch.</p><span class="heading" id="gii-php-3"></span><h3>Giải pháp 3</h3><p>    Dùng CloudFront đón tất cả request/response đến server rồi can thiệp vào header. Mình chọn cách này.</p><img alt="Solutions" itemprop="image" src="img/solutions.jpg"/><span class="heading" id="cu-hnh"></span><h2>Cấu hình</h2><p>    Các bạn có thể tìm hiểu một số khái niệm liên quan đến giải pháp này gồm:</p><ul><li><a href="https://aws.amazon.com/cloudfront/" itemprop="url">AWS CloudFront</a></li><li><a href="https://aws.amazon.com/lambda/" itemprop="url">AWS Lambda</a></li></ul><span class="heading" id="cu-hnh-aws-lambda"></span><h3>Cấu hình AWS Lambda</h3><p>    Tại sao có Lambda ở đây? Vì CloudFront giống như một người gác cổng nhưng không có vũ khí. Khi đụng chuyện sẽ cần gọi một API nào đó để nó xử lý, cụ thể ở đây là một hàm bất kỳ theo mô hình Serverless.</p><p>    Trước tiên, sau khi vào AWS Lambda, bạn <strong>BẮT BUỘC</strong> chọn <strong>Region</strong> là <code>N. Virginia (us-east-1)</code>. Chọn <strong>Create Function</strong> » <strong>Blueprints</strong> » <strong>cloudfront-modify-response-header</strong> và nhập thông tin theo hình sau.</p><img alt="Config on AWS Lambda" itemprop="image" src="img/aws-lambda.jpg"/><p>    Kéo xuống phía dưới, chọn <strong>Create Function</strong>. Tiếp theo bạn nhìn sang góc phải, chọn <strong>Actions</strong> » <strong>Publish new version</strong> và lưu ý dòng <code>ARN</code>. Sau đó nhấn <strong>Publish</strong>.</p><p>    Sau khi bạn tạo được Lambda Function, bạn sẽ chỉnh sửa lại code như sau.</p><script src="https://gist.github.com/vhnam/1aa962c19ce992011133023a4b0f4de9.js"></script><span class="heading" id="cu-hnh-aws-cloudfront"></span><h3>Cấu hình AWS CloudFront</h3><p>    Vào CloudFront chọn <strong>Create Distribution</strong> » <strong>Web</strong> » <strong>Get Stared</strong>.</p><p>    Mục <strong>Origin Settings</strong>, ở phần <strong>Origin Domain Name</strong> trỏ tới bucket cần deploy bên AWS S3 của bạn. À mà lưu ý nhé, đừng có chọn mặc định của nó. Nên nhập thẳng domain name theo cấu trúc <code>&lt;s3-bucket&gt;.s3-website&lt;region&gt;.amazonaws.com</code>. Ví dụ: <code>demo-s3.s3-website-ap-southeast-1.amazonaws.com</code>.</p><p>    Mục <strong>Default Cache Behavior Settings</strong>, ở <strong>Viewer Protocol Policy</strong> chọn <strong>Redirect HTTP to HTTPS</strong>. Ở phần <strong>Lambda Function Associations</strong>, <strong>CloudFront Event</strong> chọn <strong>Viewer Response</strong>, nhập ARN của Lambda Function đã tạo lúc nãy vào. Lưu ý một tí, nó chỉ nhận Lambda Function được tạo ở region là <code>N. Virginia (us-east-1)</code>.</p><p>    Xong rồi đó, bạn nhấn <strong>Create Distribution</strong> là được. À quên, bạn chờ <strong>Status</strong> trở thành <strong>Deployed</strong> mới được nhé. Chờ cũng khoảng hơn 10 phút lận.</p><img alt="Config on AWS Lambda" itemprop="image" src="img/aws-cloudfront.jpg"/><span class="heading" id="kt-qu"></span><h2>Kết quả</h2><p>    Bạn quay trở lại CloudFront Console, vào mục <strong>Domain Name</strong>, dán địa chỉ ấy vào trình duyệt sẽ kết quả sau khi đã cấu hình nãy giờ.</p><img alt="Result" itemprop="image" src="img/result.jpg"/><p>    Mình sẽ không nói tại sao mình phải làm cái này đâu. Dự án của công ty mà.</p></div><div class="col-lg-4 pl-5"><ul class="content__index index" id="index"><ul><li><a id="prefix-vn-" href="#vn-" class="index__item index--highlight">Vấn đề</a></li><li><a id="prefix-gii-php" href="#gii-php" class="index__item">Giải pháp</a></li><ul><li><a id="prefix-gii-php-1" href="#gii-php-1" class="index__item">Giải pháp 1</a></li><li><a id="prefix-gii-php-2" href="#gii-php-2" class="index__item">Giải pháp 2</a></li><li><a id="prefix-gii-php-3" href="#gii-php-3" class="index__item">Giải pháp 3</a></li></ul><li><a id="prefix-cu-hnh" href="#cu-hnh" class="index__item">Cấu hình</a></li><ul><li><a id="prefix-cu-hnh-aws-lambda" href="#cu-hnh-aws-lambda" class="index__item">Cấu hình AWS Lambda</a></li><li><a id="prefix-cu-hnh-aws-cloudfront" href="#cu-hnh-aws-cloudfront" class="index__item">Cấu hình AWS CloudFront</a></li></ul><li><a id="prefix-kt-qu" href="#kt-qu" class="index__item">Kết quả</a></li></ul></ul></div></div><div class="content__footer"><div class="social-plugin"><div class="like-share"><div class="fb-like"                                data-href="http://vhnam.github.io/blog/cau-hinh-aws-cloudfront-va-s3"                                data-layout="standard"                                data-action="like"                                data-show-faces="true"                                data-share="true"></div><div class="mt-3"><a href="https://twitter.com/share" class="twitter-share-button"                                    {count}                                    data-url="http://vhnam.github.io/blog/cau-hinh-aws-cloudfront-va-s3"                                    data-via="vhnam2504">Tweet</a                                ><div class="g-plusone"                                    data-annotation="inline"                                    data-width="300"></div></div></div><div class="comments"><div class="fb-comments"                                data-href="http://vhnam.github.io/blog/cau-hinh-aws-cloudfront-va-s3"                                data-numposts="10"></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="d-flex justify-content-center align-items-center text-white py-3">                    &copy; <span class="mx-1" id="footer-year"></span> Nam Vo's                    blog                </div></div></footer><script defer src="/src/assets/js/dist/bundle.js"></script><script defer src="/src/assets/js/post.js"></script><script>            (function (d,s,id) {var js,                    fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)) return;js=d.createElement(s);js.id=id;js.src =                    "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";fjs.parentNode.insertBefore(js,fjs);})(document, "script", "facebook-jssdk");</script><script>            (function(){var po=document.createElement("script");po.type = "text/javascript";po.async=true;po.src = "https://apis.google.com/js/platform.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(po,s);})();        </script><script>            !(function (d,s,id) {var js,                    fjs=d.getElementsByTagName(s)[0],                    p = /^http:/.test(d.location) ? "http" : "https";if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p + "://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}})(document, "script", "twitter-wjs");</script><script>            window.fbAsyncInit=function(){FB.init({appId: "2064203853819553",                    xfbml: true,                    version: "v3.0",});FB.AppEvents.logPageView();};(function (d,s,id) {var js,                    fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}                js=d.createElement(s);js.id=id;js.src = "https://connect.facebook.net/en_US/sdk.js";fjs.parentNode.insertBefore(js,fjs);})(document, "script", "facebook-jssdk");</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66016963-1"></script><script>            window.dataLayer=window.dataLayer || [];function gtag(){dataLayer.push(arguments);}            gtag("js", new Date());gtag("config", "UA-66016963-1");</script></body></html>